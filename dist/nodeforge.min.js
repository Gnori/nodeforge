!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).NodeForge=t()}(this,function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,c(o.key),o)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,t,n){return(t=c(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach(function(t){o(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function a(e){throw new TypeError('"'+e+'" is read-only')}function r(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(t,n){if(t){if("string"==typeof t)return e(t,n);var o={}.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?e(t,n):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t);if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}var u="node-",l={PARENT_NODEFORGE:"parent-nodeforge",NODEFORGE:"nodeforge",NODEFORGE_NODE:"nodeforge-node",NODEFORGE_DELETE:"nodeforge-delete",SELECTED:"selected",CONNECTION:"connection",MAIN_PATH:"main-path",POINT:"point",INPUTS:"inputs",OUTPUTS:"outputs",INPUT:"input",OUTPUT:"output",NODEFORGE_CONTENT_NODE:"nodeforge_content_node"},h=1,g=.5,p=1.6,v=.1,f=1,m="edit",_="fixed",y="view",x=.5,E=.5,C=6,N=.5,k=5,M=100,O=-1,S="Home",L=0,b="Delete",D="Backspace",T=1,I="nodeCreated",R="nodeRemoved",A="nodeMoved",P="nodeSelected",F="nodeUnselected",w="nodeDataChanged",z="connectionStart",H="connectionCancel",j="connectionCreated",q="connectionRemoved",U="connectionSelected",W="connectionUnselected",Z="addReroute",B="removeReroute",G="rerouteMoved",X="moduleCreated",Y="moduleChanged",J="moduleRemoved",$="click",V="clickEnd",K="contextmenu",Q="mouseMove",ee="mouseUp",te="keydown",ne="zoom",oe="translate",ie="import",se="export",ae=function(){return n(function e(n){t(this,e),this.nodeforge=n,this.managers={}},[{key:"registerManager",value:function(e,t){this.managers[e]=t}},{key:"getManager",value:function(e){return this.managers[e]}},{key:"getNodeForgeData",value:function(){return this.nodeforge.nodeforge.nodeforge}},{key:"getModule",value:function(){return this.nodeforge.module}},{key:"getContainer",value:function(){return this.nodeforge.container}},{key:"getPrecanvas",value:function(){return this.nodeforge.precanvas}},{key:"getZoom",value:function(){return this.nodeforge.zoom}},{key:"setZoom",value:function(e){this.nodeforge.zoom=e}},{key:"getZoomConfig",value:function(){return{min:this.nodeforge.zoom_min,max:this.nodeforge.zoom_max,step:this.nodeforge.zoom_value,last_value:this.nodeforge.zoom_last_value}}},{key:"getEditorMode",value:function(){return this.nodeforge.editor_mode}},{key:"getNodeSelected",value:function(){return this.nodeforge.node_selected}},{key:"setNodeSelected",value:function(e){this.nodeforge.node_selected=e}},{key:"getConnectionSelected",value:function(){return this.nodeforge.connection_selected}},{key:"setConnectionSelected",value:function(e){this.nodeforge.connection_selected=e}},{key:"getElementSelected",value:function(){return this.nodeforge.ele_selected}},{key:"setElementSelected",value:function(e){this.nodeforge.ele_selected=e}},{key:"getCanvasPosition",value:function(){return{x:this.nodeforge.canvas_x,y:this.nodeforge.canvas_y}}},{key:"setCanvasPosition",value:function(e,t){this.nodeforge.canvas_x=e,this.nodeforge.canvas_y=t}},{key:"getMousePosition",value:function(){return{x:this.nodeforge.mouse_x,y:this.nodeforge.mouse_y}}},{key:"getConnectionConfig",value:function(){return{curvature:this.nodeforge.curvature,line_path:this.nodeforge.line_path,force_first_input:this.nodeforge.force_first_input,draggable_inputs:this.nodeforge.draggable_inputs}}},{key:"getRerouteConfig",value:function(){return{curvature:this.nodeforge.reroute_curvature,curvature_start_end:this.nodeforge.reroute_curvature_start_end,width:this.nodeforge.reroute_width,fix_curvature:this.nodeforge.reroute_fix_curvature}}},{key:"getNodeRegister",value:function(){return this.nodeforge.noderegister}},{key:"getRenderFunction",value:function(){return this.nodeforge.render}},{key:"getParent",value:function(){return this.nodeforge.parent}},{key:"isUsingUuid",value:function(){return this.nodeforge.useuuid}},{key:"getNextNodeId",value:function(){return this.nodeforge.nodeId++}},{key:"isDragging",value:function(){return this.nodeforge.drag}},{key:"setDragging",value:function(e){this.nodeforge.drag=e}},{key:"isConnecting",value:function(){return this.nodeforge.connection}},{key:"setConnecting",value:function(e){this.nodeforge.connection=e}},{key:"getConnectionElement",value:function(){return this.nodeforge.connection_ele}},{key:"setConnectionElement",value:function(e){this.nodeforge.connection_ele=e}},{key:"getEventManager",value:function(){return this.managers.eventManager}},{key:"getStateManager",value:function(){return this.managers.stateManager}},{key:"getRenderManager",value:function(){return this.managers.renderManager}},{key:"getZoomManager",value:function(){return this.managers.zoomManager}},{key:"getModuleManager",value:function(){return this.managers.moduleManager}},{key:"getNodeManager",value:function(){return this.managers.nodeManager}},{key:"getConnectionManager",value:function(){return this.managers.connectionManager}},{key:"getRerouteManager",value:function(){return this.managers.rerouteManager}},{key:"getSelectionHandler",value:function(){return this.managers.selectionHandler}},{key:"getDragHandler",value:function(){return this.managers.dragHandler}},{key:"getInteractionHandler",value:function(){return this.managers.interactionHandler}}])}(),re=function(){return n(function e(n){t(this,e),this.context=n,this.events={}},[{key:"on",value:function(e,t){return"function"!=typeof t?(console.error("The listener callback must be a function, the given type is ".concat(d(t))),!1):"string"!=typeof e?(console.error("The event name must be a string, the given type is ".concat(d(e))),!1):(void 0===this.events[e]&&(this.events[e]={listeners:[]}),void this.events[e].listeners.push(t))}},{key:"removeListener",value:function(e,t){if(!this.events[e])return!1;var n=this.events[e].listeners,o=n.indexOf(t);o>-1&&n.splice(o,1)}},{key:"dispatch",value:function(e,t){if(void 0===this.events[e])return!1;this.events[e].listeners.forEach(function(e){e(t)})}},{key:"getEvents",value:function(){return this.events}},{key:"clearEvent",value:function(e){this.events[e]&&(this.events[e].listeners=[])}},{key:"clearAllEvents",value:function(){this.events={}}}])}(),ce=function(){return n(function e(n){t(this,e),this.context=n},[{key:"getNodeFromId",value:function(e){var t=this.getModuleFromNodeId(e),n=this.context.getNodeForgeData();return JSON.parse(JSON.stringify(n[t].data[e]))}},{key:"getNodesFromName",value:function(e){var t=[],n=this.context.getNodeForgeData();return Object.keys(n).map(function(o,i){for(var s in n[o].data)n[o].data[s].name===e&&t.push(n[o].data[s].id)}),t}},{key:"getModuleFromNodeId",value:function(e){var t,n=this.context.getNodeForgeData();return Object.keys(n).map(function(o,i){Object.keys(n[o].data).map(function(n,i){n==e&&(t=o)})}),t}},{key:"getCurrentModuleData",value:function(){var e=this.context.getModule();return this.context.getNodeForgeData()[e].data}},{key:"getModuleData",value:function(e){var t=this.context.getNodeForgeData();return t[e]?t[e].data:null}},{key:"nodeExists",value:function(e){return void 0!==this.getCurrentModuleData()[e]}},{key:"moduleExists",value:function(e){return void 0!==this.context.getNodeForgeData()[e]}},{key:"getAllModuleNames",value:function(){var e=this.context.getNodeForgeData();return Object.keys(e)}},{key:"getAllNodeIds",value:function(){var e=this.getCurrentModuleData();return Object.keys(e)}},{key:"getAllNodeIdsAllModules",value:function(){var e=this.context.getNodeForgeData(),t={};return Object.keys(e).forEach(function(n){t[n]=Object.keys(e[n].data)}),t}},{key:"getNodeCount",value:function(){return this.getAllNodeIds().length}},{key:"getTotalNodeCount",value:function(){var e=this.context.getNodeForgeData(),t=0;return Object.keys(e).forEach(function(n){t+=Object.keys(e[n].data).length}),t}}])}(),de=function(){return n(function e(n){t(this,e),this.context=n},[{key:"zoom_enter",value:function(e,t){e.ctrlKey&&(e.preventDefault(),e.deltaY>0?this.zoom_out():this.zoom_in())}},{key:"zoom_refresh",value:function(){var e=this.context.getZoom(),t=this.context.getCanvasPosition(),n=this.context.getZoomConfig(),o=this.context.getPrecanvas();this.context.getEventManager().dispatch(ne,e);var i=t.x/n.last_value*e,s=t.y/n.last_value*e;this.context.setCanvasPosition(i,s),this.context.nodeforge.zoom_last_value=e,o.style.transform="translate(".concat(i,"px, ").concat(s,"px) scale(").concat(e,")")}},{key:"zoom_in",value:function(){var e=this.context.getZoom(),t=this.context.getZoomConfig();e<t.max&&(this.context.setZoom(e+t.step),this.zoom_refresh())}},{key:"zoom_out",value:function(){var e=this.context.getZoom(),t=this.context.getZoomConfig();e>t.min&&(this.context.setZoom(e-t.step),this.zoom_refresh())}},{key:"zoom_reset",value:function(){1!==this.context.getZoom()&&(this.context.setZoom(h),this.zoom_refresh())}},{key:"getZoomFactors",value:function(){var e=this.context.getZoom(),t=this.context.getPrecanvas();return{widthZoom:t.clientWidth/(t.clientWidth*e)||0,heightZoom:t.clientHeight/(t.clientHeight*e)||0}}}])}(),ue=function(){return n(function e(n){t(this,e),this.context=n},[{key:"addModule",value:function(e){this.context.getNodeForgeData()[e]={data:{}},this.context.getEventManager().dispatch(X,e)}},{key:"changeModule",value:function(e){var t=this.context.getEventManager(),n=this.context.getPrecanvas();t.dispatch(Y,e),this.context.nodeforge.module=e,n.innerHTML="",this.context.setCanvasPosition(0,0),this.context.nodeforge.pos_x=0,this.context.nodeforge.pos_y=0,this.context.nodeforge.mouse_x=0,this.context.nodeforge.mouse_y=0,this.context.setZoom(h),this.context.nodeforge.zoom_last_value=f,n.style.transform="",this.context.nodeforge.import(this.context.nodeforge.nodeforge,!1)}},{key:"removeModule",value:function(e){var t=this.context.getModule(),n=this.context.getNodeForgeData(),o=this.context.getEventManager();t===e&&this.changeModule("Home"),delete n[e],o.dispatch(J,e)}},{key:"clearModuleSelected",value:function(){var e=this.context.getPrecanvas(),t=this.context.getModule(),n=this.context.getNodeForgeData();e.innerHTML="",n[t]={data:{}}}},{key:"clear",value:function(){this.context.getPrecanvas().innerHTML="",this.context.nodeforge.nodeforge={nodeforge:o({},"Home",{data:{}})}}}])}();function le(e){return e&&"string"==typeof e?e.startsWith(u)?e.slice(5):e:""}function he(e){return"".concat(u).concat(e)}function ge(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}var pe=function(){return n(function e(n){t(this,e),this.context=n},[{key:"createCurvature",value:function(e,t,n,o,i,s){var a=e,r=t,c=n,d=o,u=i;switch(s){case"open":if(e>=n)var l=a+Math.abs(c-a)*u,h=c-Math.abs(c-a)*(-1*u);else l=a+Math.abs(c-a)*u,h=c-Math.abs(c-a)*u;return" M "+a+" "+r+" C "+l+" "+r+" "+h+" "+d+" "+c+"  "+d;case"close":if(e>=n)l=a+Math.abs(c-a)*(-1*u),h=c-Math.abs(c-a)*u;else l=a+Math.abs(c-a)*u,h=c-Math.abs(c-a)*u;return" M "+a+" "+r+" C "+l+" "+r+" "+h+" "+d+" "+c+"  "+d;case"other":if(e>=n)l=a+Math.abs(c-a)*(-1*u),h=c-Math.abs(c-a)*(-1*u);else l=a+Math.abs(c-a)*u,h=c-Math.abs(c-a)*u;return" M "+a+" "+r+" C "+l+" "+r+" "+h+" "+d+" "+c+"  "+d;default:return" M "+a+" "+r+" C "+(l=a+Math.abs(c-a)*u)+" "+r+" "+(h=c-Math.abs(c-a)*u)+" "+d+" "+c+"  "+d}}},{key:"getElementCenterCoords",value:function(e,t){var n=this.context.getPrecanvas(),o=e.getBoundingClientRect(),i=n.getBoundingClientRect();return{x:e.offsetWidth/2+(o.x-i.x)*t.widthZoom,y:e.offsetHeight/2+(o.y-i.y)*t.heightZoom}}},{key:"getReroutePointCoords",value:function(e,t,n){var o=this.context.getPrecanvas(),i=e.getBoundingClientRect(),s=o.getBoundingClientRect();return{x:n/2+(i.x-s.x)*t.widthZoom,y:n/2+(i.y-s.y)*t.heightZoom}}},{key:"updateSimpleOutputConnection",value:function(e,t,n,o,i){var s=this.context.getConnectionConfig(),a=this.getElementCenterCoords(t,o),r=this.getElementCenterCoords(n,o),c=this.createCurvature(a.x,a.y,r.x,r.y,i,s.line_path);e.children[0].setAttributeNS(null,"d",c)}},{key:"updateSimpleInputConnection",value:function(e,t,n,o,i){var s=this.context.getConnectionConfig(),a=this.getElementCenterCoords(t,o),r=this.getElementCenterCoords(n,o),c=this.createCurvature(a.x,a.y,r.x,r.y,i,s.line_path);e.children[0].setAttributeNS(null,"d",c)}},{key:"updateReroutedOutputConnection",value:function(e,t,n,o,i,s,a,r){var c=this;if(this.context.getConnectionConfig(),n&&o){var d=this.getElementCenterCoords(n,i),u=this.getElementCenterCoords(o,i),l="",h=Array.from(t);h.forEach(function(e,t){var n=c.getReroutePointCoords(e,i,r);if(0===t)l+=c.createCurvature(d.x,d.y,n.x,n.y,a,"open");else{var o=c.getReroutePointCoords(h[t-1],i,r);l+=c.createCurvature(o.x,o.y,n.x,n.y,s,"other")}});var g=this.getReroutePointCoords(h[h.length-1],i,r);l+=this.createCurvature(g.x,g.y,u.x,u.y,a,"close"),e.children[0].setAttributeNS(null,"d",l)}}},{key:"updateReroutedInputConnection",value:function(e,t,n,o,i,s,a,r){var c=this;if(this.context.getConnectionConfig(),n&&o){var d=this.getElementCenterCoords(n,i),u=this.getElementCenterCoords(o,i),l="",h=Array.from(t);h.forEach(function(e,t){var n=c.getReroutePointCoords(e,i,r);if(0===t)l+=c.createCurvature(d.x,d.y,n.x,n.y,a,"open");else{var o=c.getReroutePointCoords(h[t-1],i,r);l+=c.createCurvature(o.x,o.y,n.x,n.y,s,"other")}});var g=this.getReroutePointCoords(h[h.length-1],i,r);l+=this.createCurvature(g.x,g.y,u.x,u.y,a,"close"),e.children[0].setAttributeNS(null,"d",l)}}},{key:"createConnectionElement",value:function(){var e=ge("svg"),t=ge("path");return t.classList.add("main-path"),t.setAttributeNS(null,"d",""),e.classList.add(l.CONNECTION),e.appendChild(t),e}}])}(),ve=function(){return n(function e(n){t(this,e),this.context=n},[{key:"registerNode",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.context.getNodeRegister()[e]={html:t,props:n,options:o}}},{key:"populateNodeDataAttributes",value:function(e,t,n,o,i){var s=this;null!==(n=null===n?t[o]:n[o])&&Object.entries(n).forEach(function(o,a){if("object"===d(o[1]))s.populateNodeDataAttributes(e,t,n,o[0],i+"-"+o[0]);else for(var r=e.querySelectorAll("[df-"+i+"-"+o[0]+"]"),c=0;c<r.length;c++)r[c].value=o[1],r[c].isContentEditable&&(r[c].innerText=o[1])})}},{key:"addNode",value:function(e,t,n,o,i,a,c,u){var h,g=this,p=arguments.length>8&&void 0!==arguments[8]&&arguments[8],v=this.context.isUsingUuid(),f=this.context.getNodeRegister(),m=this.context.getRenderFunction(),_=this.context.getParent(),y=this.context.getPrecanvas(),x=this.context.getNodeForgeData(),E=this.context.getModule(),C=this.context.getEventManager();h=v?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}):this.context.getNextNodeId();var N=document.createElement("div");N.classList.add("parent-node");var k,M=document.createElement("div");(M.innerHTML="",M.setAttribute("id",he(h)),M.classList.add(l.NODEFORGE_NODE),""!==a)&&(k=M.classList).add.apply(k,r(a.split(" ")));var O=document.createElement("div");O.classList.add(l.INPUTS);var S=document.createElement("div");S.classList.add(l.OUTPUTS);for(var L={},b=0;b<t;b++){var D=document.createElement("div");D.classList.add(l.INPUT),D.classList.add("input_"+(b+1)),L["input_"+(b+1)]={connections:[]},O.appendChild(D)}for(var T={},R=0;R<n;R++){var A=document.createElement("div");A.classList.add(l.OUTPUT),A.classList.add("output_"+(R+1)),T["output_"+(R+1)]={connections:[]},S.appendChild(A)}var P=document.createElement("div");if(P.classList.add("nodeforge_content_node"),!1===p)P.innerHTML=u;else if(!0===p)P.appendChild(f[u].html.cloneNode(!0));else if(3===parseInt(m.version)){var F=m.h(f[u].html,f[u].props,f[u].options);F.appContext=_,m.render(F,P)}else{var w=new m(s({parent:_,render:function(e){return e(f[u].html,{props:f[u].props})}},f[u].options)).$mount();P.appendChild(w.$el)}Object.entries(c).forEach(function(e,t){if("object"===d(e[1]))g.populateNodeDataAttributes(P,c,null,e[0],e[0]);else for(var n=P.querySelectorAll("[df-"+e[0]+"]"),o=0;o<n.length;o++)n[o].value=e[1],n[o].isContentEditable&&(n[o].innerText=e[1])}),M.appendChild(O),M.appendChild(P),M.appendChild(S),M.style.top=i+"px",M.style.left=o+"px",N.appendChild(M),y.appendChild(N);var z={id:h,name:e,data:c,class:a,html:u,typenode:p,inputs:L,outputs:T,pos_x:o,pos_y:i};return x[E].data[h]=z,C.dispatch(I,h),h}},{key:"addNodeImport",value:function(e,t){var n=this,o=this.context.getNodeRegister(),i=this.context.getRenderFunction(),a=this.context.getParent(),c=document.createElement("div");c.classList.add("parent-node");var u,h=document.createElement("div");(h.innerHTML="",h.setAttribute("id",he(e.id)),h.classList.add(l.NODEFORGE_NODE),""!==e.class)&&(u=h.classList).add.apply(u,r(e.class.split(" ")));var g=document.createElement("div");g.classList.add(l.INPUTS);var p=document.createElement("div");p.classList.add(l.OUTPUTS),Object.keys(e.inputs).map(function(n,o){var i=document.createElement("div");i.classList.add(l.INPUT),i.classList.add(n),g.appendChild(i),Object.keys(e.inputs[n].connections).map(function(o,i){var s=ge("svg"),a=ge("path");a.classList.add("main-path"),a.setAttributeNS(null,"d",""),s.classList.add(l.CONNECTION),s.classList.add("node_in_node-"+e.id),s.classList.add("node_out_node-"+e.inputs[n].connections[o].node),s.classList.add(e.inputs[n].connections[o].input),s.classList.add(n),s.appendChild(a),t.appendChild(s)})});for(var v=0;v<Object.keys(e.outputs).length;v++){var f=document.createElement("div");f.classList.add(l.OUTPUT),f.classList.add("output_"+(v+1)),p.appendChild(f)}var m=document.createElement("div");if(m.classList.add("nodeforge_content_node"),!1===e.typenode)m.innerHTML=e.html;else if(!0===e.typenode)m.appendChild(o[e.html].html.cloneNode(!0));else if(3===parseInt(i.version)){var _=i.h(o[e.html].html,o[e.html].props,o[e.html].options);_.appContext=a,i.render(_,m)}else{var y=new i(s({parent:a,render:function(t){return t(o[e.html].html,{props:o[e.html].props})}},o[e.html].options)).$mount();m.appendChild(y.$el)}Object.entries(e.data).forEach(function(t,o){if("object"===d(t[1]))n.populateNodeDataAttributes(m,e.data,null,t[0],t[0]);else for(var i=m.querySelectorAll("[df-"+t[0]+"]"),s=0;s<i.length;s++)i[s].value=t[1],i[s].isContentEditable&&(i[s].innerText=t[1])}),h.appendChild(g),h.appendChild(m),h.appendChild(p),h.style.top=e.pos_y+"px",h.style.left=e.pos_x+"px",c.appendChild(h),t.appendChild(c)}},{key:"updateNodeValue",value:function(e){for(var t=this.context.getNodeForgeData(),n=this.context.getModule(),o=this.context.getEventManager(),i=e.target.attributes,s=0;s<i.length;s++)if(i[s].nodeName.startsWith("df-")){for(var a=i[s].nodeName.slice(3).split("-"),r=t[n].data[le(e.target.closest(".nodeforge_content_node").parentElement.id)].data,c=0;c<a.length-1;c+=1)null==r[a[c]]&&(r[a[c]]={}),r=r[a[c]];r[a[a.length-1]]=e.target.value,e.target.isContentEditable&&(r[a[a.length-1]]=e.target.innerText),o.dispatch(w,le(e.target.closest(".nodeforge_content_node").parentElement.id))}}},{key:"updateNodeDataFromId",value:function(e,t){var n=this.context.getStateManager(),o=n.getNodeFromId(e),i=this.context.getNodeForgeData();i[n.getModuleFromNodeId(e)].data[e].data=t,o.html&&this.context.nodeforge.import({nodeforge:i},!1)}},{key:"addNodeInput",value:function(e){var t=this.context.getNodeForgeData(),n=this.context.getStateManager().getModuleFromNodeId(e),o=t[n].data[e],i=this.context.getContainer(),s=Object.keys(o.inputs).length;"telegram"===o.name&&(Object.keys(o.outputs).length,a("numInputs"));var r="input_"+(s+1),c=document.createElement("div");c.classList.add(l.INPUT),c.classList.add(r),i.querySelector("#node-"+e).querySelector(".inputs").appendChild(c),t[n].data[e].inputs[r]={connections:[]}}},{key:"addNodeOutput",value:function(e){var t=this.context.getNodeForgeData(),n=this.context.getStateManager().getModuleFromNodeId(e),o=t[n].data[e],i=this.context.getContainer(),s=Object.keys(o.outputs).length;"telegram"===o.name&&(Object.keys(o.inputs).length,a("numOutputs"));var r="output_"+(s+1),c=document.createElement("div");c.classList.add(l.OUTPUT),c.classList.add(r),i.querySelector("#node-"+e).querySelector(".outputs").appendChild(c),t[n].data[e].outputs[r]={connections:[]}}},{key:"removeNodeInput",value:function(e,t){var n=this.context.getNodeForgeData(),o=this.context.getStateManager(),i=this.context.getEventManager(),s=this.context.getContainer(),a=o.getModuleFromNodeId(e);n[a].data[e].inputs[t].connections.forEach(function(o,r){var c=o.node,d=o.input,u=n[a].data[c],l=e;u.outputs[d].connections.forEach(function(e,n){e.node===l&&e.output===t&&(u.outputs[d].connections.splice(n,1),s.querySelector(".connection.node_in_node-"+l+".node_out_node-"+c+"."+d+"."+t).remove(),i.dispatch(q,{output_id:c,input_id:l,output_class:d,input_class:t}))})}),delete n[a].data[e].inputs[t],s.querySelector("#node-"+e).querySelector("."+t).remove()}},{key:"removeNodeOutput",value:function(e,t){var n=this.context.getNodeForgeData(),o=this.context.getStateManager(),i=this.context.getEventManager(),s=this.context.getContainer(),a=o.getModuleFromNodeId(e);n[a].data[e].outputs[t].connections.forEach(function(o,r){var c=o.node,d=o.output,u=n[a].data[c],l=e;u.inputs[d].connections.forEach(function(e,n){e.node===l&&e.input===t&&(u.inputs[d].connections.splice(n,1),s.querySelector(".connection.node_in_node-"+c+".node_out_node-"+l+"."+t+"."+d).remove(),i.dispatch(q,{output_id:l,input_id:c,output_class:t,input_class:d}))})}),delete n[a].data[e].outputs[t],s.querySelector("#node-"+e).querySelector("."+t).remove()}},{key:"removeNodeId",value:function(e){var t=le(e),n=this.context.getContainer(),o=this.context.getStateManager(),i=this.context.getEventManager(),s=this.context.getNodeForgeData(),a=o.getModuleFromNodeId(t),r=this.context.getConnectionManager();r?r.removeConnectionNodeId(t):this.context.nodeforge.removeConnectionNodeId(t);var c=n.querySelector("#"+e);c&&c.parentElement&&c.parentElement.remove(),delete s[a].data[t],i.dispatch(R,t)}}])}(),fe=function(){return n(function e(n){t(this,e),this.context=n},[{key:"drawConnection",value:function(e){var t=this.context.getPrecanvas(),n=this.context.getEventManager();this._lastSnapTarget&&(this._lastSnapTarget.classList.remove("snap-hover"),this._lastSnapTarget=null);var o=ge("svg");this.context.setConnectionElement(o);var i=ge("path");i.classList.add("main-path"),i.setAttributeNS(null,"d",""),o.classList.add(l.CONNECTION),o.appendChild(i),t.appendChild(o);var s=le(e.parentElement.parentElement.id),a=e.classList[1];n.dispatch(z,{output_id:s,output_class:a})}},{key:"updateConnection",value:function(e,t){var n=this.context.getPrecanvas(),o=this.context.getZoom(),i=this.context.getConnectionElement(),s=this.context.getElementSelected(),a=this.context.getRenderManager(),r=this.context.getConnectionConfig(),c=this.context.getContainer();if(i&&s){var d=n.clientWidth/(n.clientWidth*o);d=d||0;var u=n.clientHeight/(n.clientHeight*o);u=u||0;var l=i.children[0],h=s.offsetWidth/2+(s.getBoundingClientRect().x-n.getBoundingClientRect().x)*d,g=s.offsetHeight/2+(s.getBoundingClientRect().y-n.getBoundingClientRect().y)*u,p=e*(n.clientWidth/(n.clientWidth*o))-n.getBoundingClientRect().x*(n.clientWidth/(n.clientWidth*o)),v=t*(n.clientHeight/(n.clientHeight*o))-n.getBoundingClientRect().y*(n.clientHeight/(n.clientHeight*o)),f=s.parentElement.parentElement.id,m=c.querySelectorAll(".input");this._lastSnapTarget&&(this._lastSnapTarget.classList.remove("snap-hover"),this._lastSnapTarget=null);for(var _=30,y=null,x=0;x<m.length;x++){var E=m[x],C=E.closest(".nodeforge-node");if(C&&C.id!==f){var N=E.getBoundingClientRect(),k=N.x+N.width/2,M=N.y+N.height/2,O=Math.sqrt(Math.pow(e-k,2)+Math.pow(t-M,2));O<_&&(_=O,y=E)}}if(y)p=y.offsetWidth/2+(y.getBoundingClientRect().x-n.getBoundingClientRect().x)*d,v=y.offsetHeight/2+(y.getBoundingClientRect().y-n.getBoundingClientRect().y)*u,y.classList.add("snap-hover"),this._lastSnapTarget=y;var S=a.createCurvature(h,g,p,v,r.curvature,r.line_path);l.setAttributeNS(null,"d",S)}}},{key:"addConnection",value:function(e,t,n,o){var i=this.context.getStateManager(),s=this.context.getNodeForgeData(),a=this.context.getModule(),r=this.context.getPrecanvas(),c=this.context.getEventManager(),d=i.getModuleFromNodeId(e);if(d===i.getModuleFromNodeId(t)){var u=i.getNodeFromId(e),h=!1;for(var g in u.outputs[n].connections){var p=u.outputs[n].connections[g];p.node===t&&p.output===o&&(h=!0)}if(!1===h){if(s[d].data[e].outputs[n].connections.push({node:t.toString(),output:o}),s[d].data[t].inputs[o].connections.push({node:e.toString(),input:n}),a===d){var v=ge("svg"),f=ge("path");f.classList.add("main-path"),f.setAttributeNS(null,"d",""),v.classList.add(l.CONNECTION),v.classList.add("node_in_node-"+t),v.classList.add("node_out_node-"+e),v.classList.add(n),v.classList.add(o),v.appendChild(f),r.appendChild(v),this.updateConnectionNodes(he(e)),this.updateConnectionNodes(he(t))}return c.dispatch(j,{output_id:e,input_id:t,output_class:n,input_class:o}),!0}}return!1}},{key:"updateConnectionNodes",value:function(e){var t=this.context.getContainer();this.context.getPrecanvas(),this.context.getNodeForgeData(),this.context.getModule();var n=this.context.getZoomManager(),o=this.context.getRenderManager(),i=this.context.getConnectionConfig(),s=this.context.getRerouteConfig(),a="node_out_"+e,r="node_in_"+e,c=t.querySelectorAll(".".concat(l.CONNECTION,".").concat(a)),d=t.querySelectorAll(".".concat(l.CONNECTION,".").concat(r)),u=n.getZoomFactors();le(e),Object.keys(c).forEach(function(n,a){var r=c[n].querySelectorAll(".point"),d=t.querySelector("#".concat(e)).querySelectorAll("."+c[n].classList[3])[0],l=c[n].classList[1].replace("node_in_",""),h=t.querySelector("#".concat(l)).querySelectorAll("."+c[n].classList[4])[0];0===r.length?o.updateSimpleOutputConnection(c[n],d,h,u,i.curvature):o.updateReroutedOutputConnection(c[n],r,d,h,u,s.curvature,s.curvature_start_end,s.width)}),Object.keys(d).forEach(function(n,a){var r=d[n].querySelectorAll(".point"),c=t.querySelector("#".concat(e)).querySelectorAll("."+d[n].classList[4])[0],l=d[n].classList[2].replace("node_out_",""),h=t.querySelector("#".concat(l)).querySelectorAll("."+d[n].classList[3])[0];0===r.length?o.updateSimpleInputConnection(d[n],h,c,u,i.curvature):o.updateReroutedInputConnection(d[n],r,h,c,u,s.curvature,s.curvature_start_end,s.width)})}},{key:"removeConnection",value:function(){var e=this.context.getConnectionSelected(),t=this.context.getEventManager(),n=this.context.getNodeForgeData(),o=this.context.getModule();if(e){var i=e.parentElement,s=i.classList;this.context.setConnectionSelected(null),e.classList.remove(l.SELECTED);var a=le(s[2].replace("node_out_","")),r=le(s[1].replace("node_in_","")),c=s[3],d=s[4],u=n[o].data[a].outputs[c].connections,h=n[o].data[r].inputs[d].connections,g=u.findIndex(function(e){return e.node===r&&e.output===d});u.splice(g,1);var p=h.findIndex(function(e){return e.node===a&&e.input===c});h.splice(p,1),i.remove(),t.dispatch(q,{output_id:a,input_id:r,output_class:c,input_class:d})}}},{key:"removeSingleConnection",value:function(e,t,n,o){var i=this.context.getStateManager(),s=this.context.getNodeForgeData(),a=this.context.getContainer(),r=this.context.getEventManager(),c=i.getModuleFromNodeId(e);if(c===i.getModuleFromNodeId(t)){var d=s[c].data[e].outputs[n].connections,u=s[c].data[t].inputs[o].connections,l=d.findIndex(function(e){return e.node===t&&e.output===o});l>-1&&d.splice(l,1);var h=u.findIndex(function(t){return t.node===e&&t.input===n});h>-1&&u.splice(h,1);var g=".connection.node_in_node-".concat(t,".node_out_node-").concat(e,".").concat(n,".").concat(o),p=a.querySelector(g);p&&p.remove(),r.dispatch(q,{output_id:e,input_id:t,output_class:n,input_class:o})}}},{key:"removeConnectionNodeId",value:function(e){for(var t=this.context.getContainer(),n=this.context.getNodeForgeData(),o=this.context.getModule(),i=this.context.getEventManager(),s="node_out_node-"+e,a="node_in_node-"+e,r=t.querySelectorAll(".".concat(l.CONNECTION,".").concat(s)),c=t.querySelectorAll(".".concat(l.CONNECTION,".").concat(a)),d=function(){var e=r[u].classList,t=le(e[2].replace("node_out_","")),s=le(e[1].replace("node_in_","")),a=e[3],c=e[4],d=n[o].data[s].inputs[c].connections,l=d.findIndex(function(e){return e.node===t&&e.input===a});d.splice(l,1);var h=n[o].data[t].outputs[a].connections,g=h.findIndex(function(e){return e.node===s&&e.output===c});h.splice(g,1),r[u].remove(),i.dispatch(q,{output_id:t,input_id:s,output_class:a,input_class:c})},u=r.length-1;u>=0;u--)d();for(var h=function(){var e=c[g].classList,t=le(e[2].replace("node_out_","")),s=le(e[1].replace("node_in_","")),a=e[3],r=e[4],d=n[o].data[t].outputs[a].connections,u=d.findIndex(function(e){return e.node===s&&e.output===r});d.splice(u,1);var l=n[o].data[s].inputs[r].connections,h=l.findIndex(function(e){return e.node===t&&e.input===a});l.splice(h,1),c[g].remove(),i.dispatch(q,{output_id:t,input_id:s,output_class:a,input_class:r})},g=c.length-1;g>=0;g--)h()}}])}(),me=function(){return n(function e(n){t(this,e),this.context=n},[{key:"removeRerouteConnectionSelected",value:function(){var e=this.context.getConnectionSelected();e&&e.classList.remove(l.SELECTED)}},{key:"createReroutePoint",value:function(e){var t=this.context.getPrecanvas(),n=this.context.getZoom(),o=this.context.getRerouteConfig(),i=this.context.getNodeForgeData(),s=this.context.getModule(),a=this.context.getEventManager(),r=this.context.getConnectionManager(),c=this.context.nodeforge,d=c.pos_x,u=c.pos_y,h=this.context.getConnectionSelected();h&&h.classList.remove(l.SELECTED);var g=e.parentElement.classList[2].replace("node_out_",""),p=le(e.parentElement.classList[1].replace("node_in_","")),v=e.parentElement.classList[3],f=e.parentElement.classList[4];this.context.setConnectionSelected(null);var m=ge("circle");m.classList.add("point");var _=d*(t.clientWidth/(t.clientWidth*n))-t.getBoundingClientRect().x*(t.clientWidth/(t.clientWidth*n)),y=u*(t.clientHeight/(t.clientHeight*n))-t.getBoundingClientRect().y*(t.clientHeight/(t.clientHeight*n));m.setAttributeNS(null,"cx",_),m.setAttributeNS(null,"cy",y),m.setAttributeNS(null,"r",o.width);var x=0;if(o.fix_curvature){var E=e.parentElement.querySelectorAll("."+l.MAIN_PATH).length,C=ge("path");if(C.classList.add("main-path"),C.setAttributeNS(null,"d",""),e.parentElement.insertBefore(C,e.parentElement.children[E]),1===E)e.parentElement.appendChild(m);else{var N=Array.from(e.parentElement.children).indexOf(e);x=N,e.parentElement.insertBefore(m,e.parentElement.children[N+E+1])}}else e.parentElement.appendChild(m);var k=g.slice(5),M=i[s].data[k].outputs[v].connections.findIndex(function(e,t){return e.node===p&&e.output===f});void 0===i[s].data[k].outputs[v].connections[M].points&&(i[s].data[k].outputs[v].connections[M].points=[]),o.fix_curvature?(x>0||0!==i[s].data[k].outputs[v].connections[M].points.length?i[s].data[k].outputs[v].connections[M].points.splice(x,0,{pos_x:_,pos_y:y}):i[s].data[k].outputs[v].connections[M].points.push({pos_x:_,pos_y:y}),e.parentElement.querySelectorAll("."+l.MAIN_PATH).forEach(function(e,t){e.classList.remove(l.SELECTED)})):i[s].data[k].outputs[v].connections[M].points.push({pos_x:_,pos_y:y}),a.dispatch(Z,k),r&&r.updateConnectionNodes(g)}},{key:"removeReroutePoint",value:function(e){var t=this.context.getRerouteConfig(),n=this.context.getNodeForgeData(),o=this.context.getModule(),i=this.context.getEventManager(),s=this.context.getConnectionManager(),a=e.parentElement.classList[2].replace("node_out_",""),r=le(e.parentElement.classList[1].replace("node_in_","")),c=e.parentElement.classList[3],d=e.parentElement.classList[4],u=Array.from(e.parentElement.children).indexOf(e),h=a.slice(5),g=n[o].data[h].outputs[c].connections.findIndex(function(e,t){return e.node===r&&e.output===d});if(t.fix_curvature){var p=e.parentElement.querySelectorAll("."+l.MAIN_PATH).length;e.parentElement.children[p-1].remove(),(u-=p)<0&&(u=0)}n[o].data[h].outputs[c].connections[g].points.splice(u,1),e.remove(),i.dispatch(B,h),s&&s.updateConnectionNodes(a)}},{key:"addRerouteImport",value:function(e){var t=this.context.getRerouteConfig(),n=this.context.getContainer();Object.keys(e.outputs).map(function(o,i){Object.keys(e.outputs[o].connections).map(function(i,s){var a=e.outputs[o].connections[i].points;void 0!==a&&a.forEach(function(s,r){var c=e.outputs[o].connections[i].node,d=e.outputs[o].connections[i].output,u=n.querySelector(".connection.node_in_node-"+c+".node_out_node-"+e.id+"."+o+"."+d);if(t.fix_curvature&&0===r)for(var l=0;l<a.length;l++){var h=ge("path");h.classList.add("main-path"),h.setAttributeNS(null,"d",""),u.appendChild(h)}var g=ge("circle");g.classList.add("point");var p=s.pos_x,v=s.pos_y;g.setAttributeNS(null,"cx",p),g.setAttributeNS(null,"cy",v),g.setAttributeNS(null,"r",t.width),u.appendChild(g)})})})}}])}(),_e=function(){return n(function e(n){t(this,e),this.context=n},[{key:"handleClick",value:function(e){return this.context.nodeforge.click(e)}},{key:"handlePosition",value:function(e){return this.context.nodeforge.position(e)}},{key:"handleDragEnd",value:function(e){return this.context.nodeforge.dragEnd(e)}},{key:"handleContextMenu",value:function(e){return this.context.nodeforge.contextmenu(e)}},{key:"handleKey",value:function(e){return this.context.nodeforge.key(e)}},{key:"handleDoubleClick",value:function(e){return this.context.nodeforge.dblclick(e)}},{key:"handlePointerDown",value:function(e){return this.context.nodeforge.pointerdown_handler(e)}},{key:"handlePointerMove",value:function(e){return this.context.nodeforge.pointermove_handler(e)}},{key:"handlePointerUp",value:function(e){return this.context.nodeforge.pointerup_handler(e)}}])}(),ye=function(){return n(function e(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t(this,e),this.context=new ae(this),this.eventManager=new re(this.context),this.stateManager=new ce(this.context),this.zoomManager=new de(this.context),this.moduleManager=new ue(this.context),this.renderManager=new pe(this.context),this.nodeManager=new ve(this.context),this.connectionManager=new fe(this.context),this.rerouteManager=new me(this.context),this.interactionHandler=new _e(this.context),this.context.registerManager("eventManager",this.eventManager),this.context.registerManager("stateManager",this.stateManager),this.context.registerManager("zoomManager",this.zoomManager),this.context.registerManager("moduleManager",this.moduleManager),this.context.registerManager("renderManager",this.renderManager),this.context.registerManager("nodeManager",this.nodeManager),this.context.registerManager("connectionManager",this.connectionManager),this.context.registerManager("rerouteManager",this.rerouteManager),this.context.registerManager("interactionHandler",this.interactionHandler),this.events=this.eventManager.events,this.container=n,this.precanvas=null,this.nodeId=T,this.ele_selected=null,this.node_selected=null,this.drag=!1,this.reroute=!1,this.reroute_fix_curvature=!1,this.curvature=N,this.reroute_curvature_start_end=E,this.reroute_curvature=x,this.reroute_width=C,this.drag_point=!1,this.editor_selected=!1,this.connection=!1,this.connection_ele=null,this.connection_selected=null,this.canvas_x=0,this.canvas_y=0,this.pos_x=0,this.pos_x_start=0,this.pos_y=0,this.pos_y_start=0,this.mouse_x=0,this.mouse_y=0,this.line_path=k,this.first_click=null,this.force_first_input=!1,this.draggable_inputs=!0,this.useuuid=!1,this.parent=s,this.noderegister={},this.render=i,this.nodeforge={nodeforge:o({},S,{data:{}})},this.module=S,this.editor_mode=m,this.zoom=h,this.zoom_max=p,this.zoom_min=g,this.zoom_value=v,this.zoom_last_value=f,this.evCache=new Array,this.prevDiff=O},[{key:"start",value:function(){this.container.classList.add(l.PARENT_NODEFORGE),this.container.tabIndex=0,this.precanvas=document.createElement("div"),this.precanvas.classList.add(l.NODEFORGE),this.container.appendChild(this.precanvas),this.container.addEventListener("mouseup",this.dragEnd.bind(this)),this.container.addEventListener("mousemove",this.position.bind(this)),this.container.addEventListener("mousedown",this.click.bind(this)),this.container.addEventListener("touchend",this.dragEnd.bind(this)),this.container.addEventListener("touchmove",this.position.bind(this)),this.container.addEventListener("touchstart",this.click.bind(this)),this.container.addEventListener("contextmenu",this.contextmenu.bind(this)),this.container.addEventListener("keydown",this.key.bind(this)),this.container.addEventListener("wheel",this.zoom_enter.bind(this)),this.container.addEventListener("input",this.updateNodeValue.bind(this)),this.container.addEventListener("dblclick",this.dblclick.bind(this)),this.container.onpointerdown=this.pointerdown_handler.bind(this),this.container.onpointermove=this.pointermove_handler.bind(this),this.container.onpointerup=this.pointerup_handler.bind(this),this.container.onpointercancel=this.pointerup_handler.bind(this),this.container.onpointerout=this.pointerup_handler.bind(this),this.container.onpointerleave=this.pointerup_handler.bind(this),this.load()}},{key:"pointerdown_handler",value:function(e){this.evCache.push(e)}},{key:"pointermove_handler",value:function(e){for(var t=0;t<this.evCache.length;t++)if(e.pointerId===this.evCache[t].pointerId){this.evCache[t]=e;break}if(2===this.evCache.length){var n=Math.abs(this.evCache[0].clientX-this.evCache[1].clientX);this.prevDiff>M&&(n>this.prevDiff&&this.zoom_in(),n<this.prevDiff&&this.zoom_out()),this.prevDiff=n}}},{key:"pointerup_handler",value:function(e){this.remove_event(e),this.evCache.length<2&&(this.prevDiff=O)}},{key:"remove_event",value:function(e){for(var t=0;t<this.evCache.length;t++)if(this.evCache[t].pointerId===e.pointerId){this.evCache.splice(t,1);break}}},{key:"load",value:function(){for(var e in this.nodeforge.nodeforge[this.module].data)this.addNodeImport(this.nodeforge.nodeforge[this.module].data[e],this.precanvas);if(this.reroute)for(var t in this.nodeforge.nodeforge[this.module].data)this.addRerouteImport(this.nodeforge.nodeforge[this.module].data[t]);for(var n in this.nodeforge.nodeforge[this.module].data)this.updateConnectionNodes(he(n));var o=this.nodeforge.nodeforge,i=1;Object.keys(o).map(function(e,t){Object.keys(o[e].data).map(function(e,t){parseInt(e)>=i&&(i=parseInt(e)+1)})}),this.nodeId=i}},{key:"removeReouteConnectionSelected",value:function(){this.dispatch(W,!0),this.reroute_fix_curvature&&this.connection_selected.parentElement.querySelectorAll("."+l.MAIN_PATH).forEach(function(e,t){e.classList.remove(l.SELECTED)})}},{key:"click",value:function(e){if(this.dispatch($,e),this.editor_mode===_){if(e.target.classList[0]!==l.PARENT_NODEFORGE&&e.target.classList[0]!==l.NODEFORGE)return!1;this.ele_selected=e.target.closest("."+l.PARENT_NODEFORGE),e.preventDefault()}else this.editor_mode===y?(null!==e.target.closest("."+l.NODEFORGE)||e.target.matches(".parent-nodeforge"))&&(this.ele_selected=e.target.closest("."+l.PARENT_NODEFORGE),e.preventDefault()):(this.first_click=e.target,this.ele_selected=e.target,e.button===L&&this.contextmenuDel(),null!==e.target.closest("."+l.NODEFORGE_CONTENT_NODE)&&(this.ele_selected=e.target.closest("."+l.NODEFORGE_CONTENT_NODE).parentElement));switch(this.ele_selected.classList[0]){case"nodeforge-node":null!==this.node_selected&&(this.node_selected.classList.remove(l.SELECTED),this.node_selected!==this.ele_selected&&this.dispatch(F,!0)),null!==this.connection_selected&&(this.connection_selected.classList.remove(l.SELECTED),this.removeReouteConnectionSelected(),this.connection_selected=null),this.node_selected!==this.ele_selected&&this.dispatch(P,le(this.ele_selected.id)),this.node_selected=this.ele_selected,this.node_selected.classList.add(l.SELECTED),this.draggable_inputs?"SELECT"!==e.target.tagName&&(this.drag=!0):"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&"SELECT"!==e.target.tagName&&!0!==e.target.hasAttribute("contenteditable")&&(this.drag=!0),this.drag&&this.ele_selected.classList.add("dragging");break;case"output":this.connection=!0,null!==this.node_selected&&(this.node_selected.classList.remove(l.SELECTED),this.node_selected=null,this.dispatch(F,!0)),null!==this.connection_selected&&(this.connection_selected.classList.remove(l.SELECTED),this.removeReouteConnectionSelected(),this.connection_selected=null),this.drawConnection(e.target);break;case"parent-nodeforge":case"nodeforge":null!==this.node_selected&&(this.node_selected.classList.remove(l.SELECTED),this.node_selected=null,this.dispatch(F,!0)),null!==this.connection_selected&&(this.connection_selected.classList.remove(l.SELECTED),this.removeReouteConnectionSelected(),this.connection_selected=null),this.editor_selected=!0;break;case"main-path":null!==this.node_selected&&(this.node_selected.classList.remove(l.SELECTED),this.node_selected=null,this.dispatch(F,!0)),null!==this.connection_selected&&(this.connection_selected.classList.remove(l.SELECTED),this.removeReouteConnectionSelected(),this.connection_selected=null),this.connection_selected=this.ele_selected,this.connection_selected.classList.add(l.SELECTED);var t=this.connection_selected.parentElement.classList;t.length>1&&(this.dispatch(U,{output_id:le(t[2].replace("node_out_","")),input_id:le(t[1].replace("node_in_","")),output_class:t[3],input_class:t[4]}),this.reroute_fix_curvature&&this.connection_selected.parentElement.querySelectorAll("."+l.MAIN_PATH).forEach(function(e,t){e.classList.add(l.SELECTED)}));break;case"point":null!==this.connection_selected&&(this.connection_selected.classList.remove(l.SELECTED),this.removeReouteConnectionSelected(),this.connection_selected=null),this.drag_point=!0,this.ele_selected.classList.add(l.SELECTED);break;case"nodeforge-delete":this.node_selected&&this.removeNodeId(this.node_selected.id),this.connection_selected&&this.removeConnection(),null!==this.node_selected&&(this.node_selected.classList.remove(l.SELECTED),this.node_selected=null,this.dispatch(F,!0)),null!==this.connection_selected&&(this.connection_selected.classList.remove(l.SELECTED),this.removeReouteConnectionSelected(),this.connection_selected=null)}"touchstart"===e.type?(this.pos_x=e.touches[0].clientX,this.pos_x_start=e.touches[0].clientX,this.pos_y=e.touches[0].clientY,this.pos_y_start=e.touches[0].clientY,this.mouse_x=e.touches[0].clientX,this.mouse_y=e.touches[0].clientY):(this.pos_x=e.clientX,this.pos_x_start=e.clientX,this.pos_y=e.clientY,this.pos_y_start=e.clientY),[l.INPUT,l.OUTPUT,l.MAIN_PATH].includes(this.ele_selected.classList[0])&&e.preventDefault(),this.dispatch(V,e)}},{key:"position",value:function(e){var t,n;if("touchmove"===e.type?(t=e.touches[0].clientX,n=e.touches[0].clientY):(t=e.clientX,n=e.clientY),this.connection&&this.updateConnection(t,n),this.editor_selected){var o=this.canvas_x+-(this.pos_x-t),i=this.canvas_y+-(this.pos_y-n);this.dispatch(oe,{x:o,y:i}),this.precanvas.style.transform="translate("+o+"px, "+i+"px) scale("+this.zoom+")"}if(this.drag){e.preventDefault();var s=(this.pos_x-t)*this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom),a=(this.pos_y-n)*this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom);this.pos_x=t,this.pos_y=n;var r=this.ele_selected.offsetLeft-s,c=this.ele_selected.offsetTop-a;this.ele_selected.style.top=c+"px",this.ele_selected.style.left=r+"px",this.nodeforge.nodeforge[this.module].data[le(this.ele_selected.id)].pos_x=r,this.nodeforge.nodeforge[this.module].data[le(this.ele_selected.id)].pos_y=c,this.updateConnectionNodes(this.ele_selected.id)}if(this.drag_point){this.pos_x,this.precanvas.clientWidth,this.precanvas.clientWidth,this.zoom,this.pos_y,this.precanvas.clientHeight,this.precanvas.clientHeight,this.zoom,this.pos_x=t,this.pos_y=n;var d=this.pos_x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))-this.precanvas.getBoundingClientRect().x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom)),u=this.pos_y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))-this.precanvas.getBoundingClientRect().y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom));this.ele_selected.setAttributeNS(null,"cx",d),this.ele_selected.setAttributeNS(null,"cy",u);var h=this.ele_selected.parentElement.classList[2].replace("node_out_",""),g=le(this.ele_selected.parentElement.classList[1].replace("node_in_","")),p=this.ele_selected.parentElement.classList[3],v=this.ele_selected.parentElement.classList[4],f=Array.from(this.ele_selected.parentElement.children).indexOf(this.ele_selected)-1;if(this.reroute_fix_curvature)(f-=this.ele_selected.parentElement.querySelectorAll("."+l.MAIN_PATH).length-1)<0&&(f=0);var m=h.slice(5),_=this.nodeforge.nodeforge[this.module].data[m].outputs[p].connections.findIndex(function(e,t){return e.node===g&&e.output===v});this.nodeforge.nodeforge[this.module].data[m].outputs[p].connections[_].points[f]={pos_x:d,pos_y:u};var y=this.ele_selected.parentElement.classList[2].replace("node_out_","");this.updateConnectionNodes(y)}"touchmove"===e.type&&(this.mouse_x=t,this.mouse_y=n),this.dispatch(Q,{x:t,y:n})}},{key:"dragEnd",value:function(e){var t,n,o;if("touchend"===e.type?(t=this.mouse_x,n=this.mouse_y,o=document.elementFromPoint(t,n)):(t=e.clientX,n=e.clientY,o=e.target),this.drag&&(this.pos_x_start===t&&this.pos_y_start===n||this.dispatch(A,le(this.ele_selected.id))),this.drag_point&&(this.ele_selected.classList.remove(l.SELECTED),this.pos_x_start===t&&this.pos_y_start===n||this.dispatch(G,le(this.ele_selected.parentElement.classList[2].replace("node_out_","")))),this.editor_selected&&(this.canvas_x=this.canvas_x+-(this.pos_x-t),this.canvas_y=this.canvas_y+-(this.pos_y-n),this.editor_selected=!1),!0===this.connection)if(this.connectionManager._lastSnapTarget&&(o=this.connectionManager._lastSnapTarget,this.connectionManager._lastSnapTarget.classList.remove("snap-hover"),this.connectionManager._lastSnapTarget=null),o.classList[0]===l.INPUT||this.force_first_input&&(null!==o.closest("."+l.NODEFORGE_CONTENT_NODE)||o.classList[0]===l.NODEFORGE_NODE)){var i,s;!this.force_first_input||null===o.closest("."+l.NODEFORGE_CONTENT_NODE)&&o.classList[0]!==l.NODEFORGE_NODE?(i=o.parentElement.parentElement.id,s=o.classList[1]):(i=null!==o.closest("."+l.NODEFORGE_CONTENT_NODE)?o.closest("."+l.NODEFORGE_CONTENT_NODE).parentElement.id:o.id,s=0!==Object.keys(this.getNodeFromId(i.slice(5)).inputs).length&&"input_1");var a=this.ele_selected.parentElement.parentElement.id,r=this.ele_selected.classList[1];if(a!==i&&!1!==s){if(0===this.container.querySelectorAll(".connection.node_in_"+i+".node_out_"+a+"."+r+"."+s).length){this.connection_ele.classList.add("node_in_"+i),this.connection_ele.classList.add("node_out_"+a),this.connection_ele.classList.add(r),this.connection_ele.classList.add(s);var c=le(i),d=le(a);this.nodeforge.nodeforge[this.module].data[d].outputs[r].connections.push({node:c,output:s}),this.nodeforge.nodeforge[this.module].data[c].inputs[s].connections.push({node:d,input:r}),this.updateConnectionNodes(he(d)),this.updateConnectionNodes(he(c)),this.dispatch(j,{output_id:d,input_id:c,output_class:r,input_class:s})}else this.dispatch(H,!0),this.connection_ele.remove();this.connection_ele=null}else this.dispatch(H,!0),this.connection_ele.remove(),this.connection_ele=null}else this.dispatch(H,!0),this.connection_ele.remove(),this.connection_ele=null;this.drag&&this.ele_selected&&this.ele_selected.classList.remove("dragging"),this.drag=!1,this.drag_point=!1,this.connection=!1,this.ele_selected=null,this.editor_selected=!1,this.dispatch(ee,e)}},{key:"contextmenu",value:function(e){if(this.dispatch(K,e),e.preventDefault(),this.editor_mode===_||this.editor_mode===y)return!1;if(this.precanvas.getElementsByClassName(l.NODEFORGE_DELETE).length&&this.precanvas.getElementsByClassName(l.NODEFORGE_DELETE)[0].remove(),this.node_selected||this.connection_selected){var t=document.createElement("div");t.classList.add(l.NODEFORGE_DELETE),t.innerHTML="x",this.node_selected&&this.node_selected.appendChild(t),this.connection_selected&&this.connection_selected.parentElement.classList.length>1&&(t.style.top=e.clientY*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))-this.precanvas.getBoundingClientRect().y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))+"px",t.style.left=e.clientX*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))-this.precanvas.getBoundingClientRect().x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))+"px",this.precanvas.appendChild(t))}}},{key:"contextmenuDel",value:function(){this.precanvas.getElementsByClassName(l.NODEFORGE_DELETE).length&&this.precanvas.getElementsByClassName(l.NODEFORGE_DELETE)[0].remove()}},{key:"key",value:function(e){if(this.dispatch(te,e),this.editor_mode===_||this.editor_mode===y)return!1;(e.key===b||e.key===D&&e.metaKey)&&(null!==this.node_selected&&"INPUT"!==this.first_click.tagName&&"TEXTAREA"!==this.first_click.tagName&&!0!==this.first_click.hasAttribute("contenteditable")&&(this.removeNodeId(this.node_selected.id),this.node_selected=null,this.dispatch(F,!0)),null!==this.connection_selected&&(this.removeConnection(),this.connection_selected=null))}},{key:"zoom_enter",value:function(e,t){return this.zoomManager.zoom_enter(e,t)}},{key:"zoom_refresh",value:function(){return this.zoomManager.zoom_refresh()}},{key:"zoom_in",value:function(){return this.zoomManager.zoom_in()}},{key:"zoom_out",value:function(){return this.zoomManager.zoom_out()}},{key:"zoom_reset",value:function(){return this.zoomManager.zoom_reset()}},{key:"createCurvature",value:function(e,t,n,o,i,s){return this.renderManager.createCurvature(e,t,n,o,i,s)}},{key:"drawConnection",value:function(e){return this.connectionManager.drawConnection(e)}},{key:"updateConnection",value:function(e,t){return this.connectionManager.updateConnection(e,t)}},{key:"addConnection",value:function(e,t,n,o){return this.connectionManager.addConnection(e,t,n,o)}},{key:"getZoomFactors",value:function(){return this.zoomManager.getZoomFactors()}},{key:"getElementCenterCoords",value:function(e,t){return this.renderManager.getElementCenterCoords(e,t)}},{key:"getReroutePointCoords",value:function(e,t,n){return this.renderManager.getReroutePointCoords(e,t,n)}},{key:"updateSimpleOutputConnection",value:function(e,t,n,o,i){return this.renderManager.updateSimpleOutputConnection(e,t,n,o,i)}},{key:"updateSimpleInputConnection",value:function(e,t,n,o,i){return this.renderManager.updateSimpleInputConnection(e,t,n,o,i)}},{key:"updateReroutedOutputConnection",value:function(e,t,n,o,i,s,a,r){return this.renderManager.updateReroutedOutputConnection(e,t,n,o,i,s,a,r)}},{key:"updateReroutedInputConnection",value:function(e,t,n,o,i,s,a,r){return this.renderManager.updateReroutedInputConnection(e,t,n,o,i,s,a,r)}},{key:"updateConnectionNodes",value:function(e){return this.connectionManager.updateConnectionNodes(e)}},{key:"dblclick",value:function(e){e.target.classList[0]!==l.POINT?null!==this.connection_selected&&this.reroute&&this.createReroutePoint(this.connection_selected):this.removeReroutePoint(e.target)}},{key:"createReroutePoint",value:function(e){return this.rerouteManager.createReroutePoint(e)}},{key:"removeReroutePoint",value:function(e){return this.rerouteManager.removeReroutePoint(e)}},{key:"registerNode",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this.nodeManager.registerNode(e,t,n,o)}},{key:"populateNodeDataAttributes",value:function(e,t,n,o,i){return this.nodeManager.populateNodeDataAttributes(e,t,n,o,i)}},{key:"getNodeFromId",value:function(e){return this.stateManager.getNodeFromId(e)}},{key:"getNodesFromName",value:function(e){return this.stateManager.getNodesFromName(e)}},{key:"addNode",value:function(e,t,n,o,i,s,a,r){var c=arguments.length>8&&void 0!==arguments[8]&&arguments[8];return this.nodeManager.addNode(e,t,n,o,i,s,a,r,c)}},{key:"addNodeImport",value:function(e,t){return this.nodeManager.addNodeImport(e,t)}},{key:"addRerouteImport",value:function(e){return this.rerouteManager.addRerouteImport(e)}},{key:"updateNodeValue",value:function(e){return this.nodeManager.updateNodeValue(e)}},{key:"updateNodeDataFromId",value:function(e,t){return this.nodeManager.updateNodeDataFromId(e,t)}},{key:"addNodeInput",value:function(e){return this.nodeManager.addNodeInput(e)}},{key:"addNodeOutput",value:function(e){return this.nodeManager.addNodeOutput(e)}},{key:"removeNodeInput",value:function(e,t){return this.nodeManager.removeNodeInput(e,t)}},{key:"removeNodeOutput",value:function(e,t){return this.nodeManager.removeNodeOutput(e,t)}},{key:"removeNodeId",value:function(e){return this.nodeManager.removeNodeId(e)}},{key:"removeConnection",value:function(){return this.connectionManager.removeConnection()}},{key:"removeSingleConnection",value:function(e,t,n,o){return this.connectionManager.removeSingleConnection(e,t,n,o)}},{key:"removeConnectionNodeId",value:function(e){return this.connectionManager.removeConnectionNodeId(e)}},{key:"getModuleFromNodeId",value:function(e){return this.stateManager.getModuleFromNodeId(e)}},{key:"addModule",value:function(e){return this.moduleManager.addModule(e)}},{key:"changeModule",value:function(e){return this.moduleManager.changeModule(e)}},{key:"removeModule",value:function(e){return this.moduleManager.removeModule(e)}},{key:"clearModuleSelected",value:function(){return this.moduleManager.clearModuleSelected()}},{key:"clear",value:function(){return this.moduleManager.clear()}},{key:"export",value:function(){var e=JSON.parse(JSON.stringify(this.nodeforge));return this.dispatch(se,e),e}},{key:"import",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.clear(),this.nodeforge=JSON.parse(JSON.stringify(e)),this.load(),t&&this.dispatch(ie,"import")}},{key:"on",value:function(e,t){return this.eventManager.on(e,t)}},{key:"removeListener",value:function(e,t){return this.eventManager.removeListener(e,t)}},{key:"dispatch",value:function(e,t){return this.eventManager.dispatch(e,t)}}])}();return ye});
